<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ShinePro Dilution Calculator</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#111722; --muted:#9fb0c3; --text:#e9f0f7; --accent:#4cc9f0; --accent2:#80ffdb; --danger:#ff6b6b; --ring:0 0 0 3px rgba(76,201,240,.25);
      --line: rgba(255,255,255,0.08);
    }
    [data-theme="light"]{
      --bg:#f8fafc; --panel:#ffffff; --muted:#475569; --text:#0f172a; --accent:#0ea5e9; --accent2:#14b8a6; --danger:#dc2626; --ring:0 0 0 3px rgba(14,165,233,.25);
      --line: rgba(2,6,23,0.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--text); display:flex; justify-content:center; padding:24px}
    .app{width:min(1100px,100%)}

    .card{background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.12); margin-bottom:14px}
    h1.title{font-size:clamp(26px,3.5vw,36px); margin:0 0 6px; font-weight:800}
    p.sub{color:var(--muted); margin:0 0 12px}
    .kicker{font-size:12px; color:var(--muted)}

    .grid{display:grid; grid-template-columns:1.1fr .9fr; gap:16px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}

    label{display:block; font-size:12px; letter-spacing:.3px; text-transform:uppercase; color:var(--muted); margin:0 0 6px}
    .ctl{display:flex; gap:8px; align-items:center; background:rgba(0,0,0,.06); border:1px solid var(--line); border-radius:12px; padding:10px 12px}
    [data-theme="light"] .ctl{background:rgba(2,6,23,.03)}
    .ctl:focus-within{box-shadow:var(--ring); border-color:#2b4d66}
    .ctl input,.ctl select{flex:1; background:transparent; border:0; outline:0; color:var(--text); font-size:16px}
    .units{min-width:90px}

    .btn{cursor:pointer; border:1px solid var(--line); background:linear-gradient(180deg, rgba(76,201,240,.12), rgba(0,0,0,0)); color:var(--text); border-radius:12px; padding:10px 14px; font-weight:700}
    .btn.secondary{background:transparent}
    .btn.ghost{background:transparent; border-color:var(--line); color:var(--muted)}
    .btn:hover{filter:brightness(1.05)}
    .footer{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .badge{display:inline-flex; align-items:center; gap:8px; background:transparent; border:1px dashed var(--line); border-radius:999px; padding:8px 12px; color:var(--muted)}

    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{border:1px solid var(--line); background:transparent; color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:600}
    .tab.active{outline: var(--ring);}

    .result{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:650px){.result{grid-template-columns:1fr}}
    .result .box{background:linear-gradient(180deg, rgba(128,255,219,.12), rgba(0,0,0,0)); border:1px solid rgba(20,184,166,.25); border-radius:14px; padding:14px}
    .result .big{font-size:clamp(28px,5vw,42px); font-weight:900}

    .presets{display:flex; flex-wrap:wrap; gap:8px}
    .chip{padding:8px 10px; border-radius:999px; border:1px solid var(--line); background:transparent; cursor:pointer}

    .library{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:900px){.library{grid-template-columns:1fr}}
    .prod{background:transparent; border:1px solid var(--line); border-radius:14px; padding:14px}
    .prod .brand{color:var(--muted); font-size:12px; text-transform:uppercase}
    .usechips{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px}
    .usechip{padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:transparent; cursor:pointer}

    /* Mobile comfort */
    input, select, button { min-height: 44px; }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="card" style="display:flex; justify-content:space-between; align-items:center">
      <div>
        <h1 class="title">ShinePro Dilution Calculator</h1>
        <p class="sub">Three quick steps: <strong>1)</strong> Pick a use‑case, <strong>2)</strong> Enter your amount, <strong>3)</strong> Pour the shown chemical and fill with water.</p>
        <div class="footer">
          <label class="badge"><input id="themeToggle" type="checkbox"> Light mode</label>
        </div>
      </div>
      <div class="kicker">v1.0</div>
    </header>

    <!-- Onboarding tip -->
    <div class="card" id="tipCard" style="display:block; background:linear-gradient(180deg, rgba(128,255,219,.12), rgba(0,0,0,0));">
      <strong>New here?</strong> Try <em>Quick Mix</em> – tap a big preset like <code>Interior 1:15</code>, type how much you want (e.g., 500 mL), and you’ll get exactly how much chemical to pour.
      <div class="footer"><button class="btn" id="dismissTip">Got it</button></div>
    </div>

    <!-- Quick Mix (Beginner) -->
    <section id="quickMix" class="card">
      <h3 style="margin-top:0">Quick Mix</h3>
      <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px">
        <button class="btn" data-preset="1:5">Exterior 1:5</button>
        <button class="btn" data-preset="1:10">Exterior 1:10</button>
        <button class="btn" data-preset="1:15">Interior 1:15</button>
        <button class="btn" data-preset="1:20">Interior 1:20</button>
        <button class="btn" data-preset="1:30">Maintenance 1:30</button>
        <button class="btn" data-preset="1:50">Light 1:50</button>
      </div>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <label for="qmRatio">Ratio</label>
          <div class="ctl"><input id="qmRatio" placeholder="e.g. 1:15 or 10%" value="1:15"></div>
          <div style="margin-top:8px">
            <input id="qmSlider" type="range" min="3" max="256" step="1" value="15" style="width:100%">
            <div class="kicker">Slide to adjust (1:W)</div>
          </div>
        </div>
        <div>
          <label for="qmAmount">Total amount I want</label>
          <div class="ctl">
            <input id="qmAmount" type="number" min="0" step="0.01" value="0.5">
            <select id="qmUnit" class="units"><option value="L">L</option><option value="mL">mL</option><option value="oz">oz</option></select>
          </div>
          <div class="footer">
            <button class="btn" id="qmGo">Calculate</button>
            <button class="btn secondary" id="qmRound">Round to nice numbers</button>
          </div>
        </div>
      </div>
      <div class="result" style="margin-top:12px">
        <div class="box"><h3>Pour this much chemical</h3><div class="big" id="qmChem">—</div><div class="muted" id="qmChemAlt">&nbsp;</div></div>
        <div class="box"><h3>Then add water up to</h3><div class="big" id="qmWater">—</div><div class="muted" id="qmWaterAlt">&nbsp;</div></div>
      </div>
      <p class="kicker">Use a measuring cup for the chemical, then top up with water to your target total.</p>
    </section>

    <!-- Advanced Calculator hidden by default -->
    <details class="card">
      <summary style="cursor:pointer; font-weight:700">Advanced Calculator (show)</summary>
      <div class="grid">
        <!-- INPUTS -->
        <section aria-label="Inputs">
          <div class="tabs" role="tablist" aria-label="Calculation mode">
            <button class="tab active" data-mode="water" role="tab" aria-selected="true">Given Water Volume</button>
            <button class="tab" data-mode="total" role="tab" aria-selected="false">Given Total Solution</button>
            <button class="tab" data-mode="percent" role="tab" aria-selected="false">By % Concentrate</button>
          </div>

          <div class="grid" style="grid-template-columns:1fr 1fr">
            <div>
              <label for="ratioChem">Dilution Ratio (C:W)</label>
              <div class="ctl">
                <input id="ratioChem" type="number" min="0" step="1" value="1" aria-label="Concentrate part" style="max-width:120px">
                <span style="opacity:.7">:</span>
                <input id="ratioWater" type="number" min="0" step="1" value="10" aria-label="Water part" style="max-width:120px">
              </div>
            </div>
            <div id="percentWrap" style="display:none">
              <label for="percent">Desired % Concentrate</label>
              <div class="ctl"><input id="percent" type="number" min="0" max="100" step="0.1" value="9.1"></div>
            </div>
          </div>

          <div class="grid" style="grid-template-columns:1fr 1fr; margin-top:10px">
            <div id="waterWrap">
              <label for="water">Water Amount</label>
              <div class="ctl">
                <input id="water" type="number" min="0" step="0.01" value="1">
                <select id="waterUnit" class="units"><option value="L">L</option><option value="mL">mL</option><option value="gal">gal</option><option value="oz">oz</option></select>
              </div>
            </div>
            <div id="totalWrap" style="display:none">
              <label for="total">Total Solution</label>
              <div class="ctl">
                <input id="total" type="number" min="0" step="0.01" value="1">
                <select id="totalUnit" class="units"><option value="L">L</option><option value="mL">mL</option><option value="gal">gal</option><option value="oz">oz</option></select>
              </div>
            </div>
          </div>

          <div class="footer">
            <span class="badge" id="ratioBadge">Ratio 1:10 → 9.09% concentrate</span>
            <button class="btn" id="swapBtn" title="Swap concentrate/water parts">Swap parts</button>
            <button class="btn ghost" id="resetBtn">Reset</button>
          </div>
        </section>

        <!-- RESULTS -->
        <section aria-label="Results">
          <div class="result">
            <div class="box"><h3>Concentrate Needed</h3><div class="big" id="chemMain">—</div><div class="muted" id="chemAlt">&nbsp;</div></div>
            <div class="box"><h3>Water Needed</h3><div class="big" id="waterMain">—</div><div class="muted" id="waterAlt">&nbsp;</div></div>
          </div>
          <p class="kicker" style="margin-top:8px">Tip: Click a preset below to auto‑fill typical detailing dilutions.</p>
        </section>
      </div>
    </details>

    <!-- Presets + Bottle Helper -->
    <section class="card">
      <div class="grid">
        <div>
          <h3 style="margin:0 0 8px">Quick Presets</h3>
          <div class="presets" id="presets"></div>
        </div>
        <div>
          <h3 style="margin:0 0 8px">Bottle Size Helper</h3>
          <div class="grid" style="grid-template-columns:1fr auto">
            <div>
              <label for="bottle">Bottle Size</label>
              <div class="ctl">
                <input id="bottle" type="number" min="0" step="0.01" value="1">
                <select id="bottleUnit" class="units"><option value="L">L</option><option value="mL">mL</option><option value="oz">oz</option></select>
              </div>
            </div>
            <div style="display:flex; align-items:flex-end"><button class="btn" id="planBottle">Calculate</button></div>
          </div>
          <div class="grid" style="grid-template-columns:1fr 1fr; margin-top:10px">
            <div>
              <label for="waterOverride">Optional: Adjust Water</label>
              <div class="ctl">
                <input id="waterOverride" type="number" min="0" step="0.01" placeholder="e.g. 0.95">
                <select id="waterOverrideUnit" class="units"><option value="same">Same as bottle</option><option value="L">L</option><option value="mL">mL</option><option value="oz">oz</option></select>
              </div>
            </div>
          </div>
          <div class="result" style="margin-top:10px">
            <div class="box"><h3>For This Bottle</h3><div class="big" id="bottleChem">—</div><div class="muted" id="bottleChemAlt">&nbsp;</div></div>
            <div class="box"><h3>Water in Bottle</h3><div class="big" id="bottleWater">—</div><div class="muted" id="bottleWaterAlt">&nbsp;</div></div>
          </div>
          <p class="kicker" id="bottleNote" style="margin-top:6px"></p>
        </div>
      </div>
    </section>

    <!-- Chemical Library -->
    <section class="card" aria-label="Chemical Library">
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <h3 style="margin:0 0 8px">Chemical Library</h3>
          <p class="kicker" style="margin:0 0 10px">Browse popular products and one‑tap apply a recommended ratio. Always verify with the label/SDS.</p>
        </div>
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <div>
            <label for="chemSearch">Search</label>
            <div class="ctl"><input id="chemSearch" placeholder="Brand or product name"></div>
          </div>
          <div>
            <label for="chemBrand">Brand</label>
            <div class="ctl"><select id="chemBrand" class="units"><option value="">All brands</option></select></div>
          </div>
        </div>
      </div>
      <div id="chemList" class="library"></div>
      <div class="footer">
        <button class="btn secondary" id="exportDb">Export JSON</button>
        <label class="btn" for="importDbInput" style="cursor:pointer">Import JSON</label>
        <input id="importDbInput" type="file" accept="application/json" style="display:none">
      </div>
    </section>

    <p class="kicker">Math: For ratio <em>C:W</em> → concentrate fraction <em>C/(C+W)</em>. Given water amount <em>A</em>, chemical = <em>(C/W)×A</em>; total = <em>A×(1+C/W)</em>. Given total <em>T</em>, chemical = <em>T×C/(C+W)</em>, water = <em>T×W/(C+W)</em>.</p>
  </div>

  <script>
    // -------- Theme + Tips --------
    const root=document.documentElement;
    const themeToggle=document.querySelector('#themeToggle');
    const savedTheme=localStorage.getItem('shinepro_theme');
    if(savedTheme){ root.setAttribute('data-theme', savedTheme); if(savedTheme==='light') themeToggle.checked=true; }
    themeToggle.addEventListener('change',()=>{ const t=themeToggle.checked?'light':'dark'; root.setAttribute('data-theme',t); localStorage.setItem('shinepro_theme',t); });

    const tip=document.getElementById('tipCard');
    const dismissTip=document.getElementById('dismissTip');
    if(localStorage.getItem('shinepro_tip')==='1' && tip){ tip.style.display='none'; }
    if(dismissTip){ dismissTip.addEventListener('click',()=>{ tip.style.display='none'; localStorage.setItem('shinepro_tip','1'); }); }

    // -------- Units helper --------
    const Unit={
      toML(v,u){v=+v||0; if(u==='mL')return v; if(u==='L')return v*1000; if(u==='oz')return v*29.5735; if(u==='gal')return v*3785.41; return v},
      fromML(v,u){if(u==='mL')return v; if(u==='L')return v/1000; if(u==='oz')return v/29.5735; if(u==='gal')return v/3785.41; return v},
      fmt(v){if(!isFinite(v))return '—'; const n=Math.abs(v)>=100?0:Math.abs(v)>=10?2:3; return Number(v.toFixed(n)).toLocaleString()}
    };

    // -------- Quick Mix (Beginner) --------
    const qmRatio=document.getElementById('qmRatio');
    const qmSlider=document.getElementById('qmSlider');
    const qmAmount=document.getElementById('qmAmount');
    const qmUnit=document.getElementById('qmUnit');
    const qmChem=document.getElementById('qmChem');
    const qmChemAlt=document.getElementById('qmChemAlt');
    const qmWater=document.getElementById('qmWater');
    const qmWaterAlt=document.getElementById('qmWaterAlt');

    function parseQuickRatio(txt){ if(!txt) return null; txt=String(txt).trim().toLowerCase();
      const pct=txt.match(/([0-9]*\.?[0-9]+)\s*%/); if(pct){const p=+pct[1]; if(p>0&&p<100){return {c:1,w:(100-p)/p};}}
      const m=txt.match(/([0-9]*\.?[0-9]+)\s*[:\/-x]\s*([0-9]*\.?[0-9]+)/); if(m){return {c:+m[1],w:+m[2]};}
      return null;
    }
    function setSliderFromRatio(){ const r=parseQuickRatio(qmRatio.value); if(r){ qmSlider.value=Math.max(3,Math.min(256,Math.round(r.w))); }}
    function calcQuickMix(round=false){ const r=parseQuickRatio(qmRatio.value); if(!r){ qmChem.textContent='—'; qmWater.textContent='—'; qmChemAlt.textContent=''; qmWaterAlt.textContent=''; return; }
      const totalML=Unit.toML(+qmAmount.value||0,qmUnit.value); const fracC=r.c/(r.c+r.w); const fracW=r.w/(r.c+r.w);
      let chemML=totalML*fracC; let waterML=totalML*fracW;
      if(round){ const step=qmUnit.value==='mL'?10:qmUnit.value==='L'?0.05:1; const toU=v=>Unit.fromML(v,qmUnit.value); const fromU=v=>Unit.toML(v,qmUnit.value); chemML=fromU(Math.round(toU(chemML)/step)*step); waterML=Math.max(0,totalML-chemML); }
      const alt=qmUnit.value==='L'?'mL':qmUnit.value==='mL'?'L':qmUnit.value==='oz'?'mL':'oz';
      qmChem.textContent=`${Unit.fmt(Unit.fromML(chemML,qmUnit.value))} ${qmUnit.value}`;
      qmChemAlt.textContent=`${Unit.fmt(Unit.fromML(chemML,alt))} ${alt}`;
      qmWater.textContent=`${Unit.fmt(Unit.fromML(waterML,qmUnit.value))} ${qmUnit.value}`;
      qmWaterAlt.textContent=`${Unit.fmt(Unit.fromML(waterML,alt))} ${alt}`;
    }
    document.getElementById('qmGo').addEventListener('click',()=>calcQuickMix(false));
    document.getElementById('qmRound').addEventListener('click',()=>calcQuickMix(true));
    qmSlider.addEventListener('input',()=>{ qmRatio.value=`1:${qmSlider.value}`; calcQuickMix(false); });
    qmRatio.addEventListener('input',()=>{ setSliderFromRatio(); calcQuickMix(false); });
    qmAmount.addEventListener('input',()=>calcQuickMix(false));
    qmUnit.addEventListener('input',()=>calcQuickMix(false));
    document.querySelectorAll('#quickMix .btn[data-preset]').forEach(btn=>btn.addEventListener('click',()=>{ qmRatio.value=btn.dataset.preset; setSliderFromRatio(); calcQuickMix(false);}));
    setSliderFromRatio(); calcQuickMix(false);

    // -------- Advanced Calculator --------
    const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
    const ratioChem=$('#ratioChem'); const ratioWater=$('#ratioWater'); const percent=$('#percent');
    const waterWrap=$('#waterWrap'); const water=$('#water'); const waterUnit=$('#waterUnit');
    const totalWrap=$('#totalWrap'); const total=$('#total'); const totalUnit=$('#totalUnit');
    const percentWrap=$('#percentWrap'); const ratioBadge=$('#ratioBadge');
    const chemMain=$('#chemMain'); const chemAlt=$('#chemAlt'); const waterMain=$('#waterMain'); const waterAlt=$('#waterAlt');
    const tabs=$$('.tab'); let mode='water';

    function clampPos(n){ return Math.max(0, Number(n||0)); }
    function ratioToPercent(c,w){ c=clampPos(c); w=clampPos(w); const pct=(c/(c+w))*100; return isFinite(pct)?pct:0; }
    function percentToRatio(pct){ const p=clampPos(pct); if(p<=0) return {c:0,w:1}; const w=(100-p)/p; return {c:1,w}; }
    function updateFromRatio(){ const c=clampPos(ratioChem.value); const w=clampPos(ratioWater.value); const pct=ratioToPercent(c,w); ratioBadge.textContent=`Ratio ${c}:${w} → ${pct.toFixed(2)}% concentrate`; }
    function applyPercentToRatio(){ const pr=percentToRatio(percent.value); ratioChem.value=1; ratioWater.value=pr.w; updateFromRatio(); }

    tabs.forEach(t=>t.addEventListener('click',()=>{ tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); mode=t.dataset.mode;
      const isWater=mode==='water', isTotal=mode==='total', isPct=mode==='percent';
      waterWrap.style.display=isWater?'block':'none'; totalWrap.style.display=isTotal?'block':'none'; percentWrap.style.display=isPct?'block':'none'; if(isPct) applyPercentToRatio(); compute(); }));
    [ratioChem,ratioWater].forEach(el=>el.addEventListener('input',()=>{updateFromRatio(); compute(); }));
    [water,waterUnit,total,totalUnit,percent].forEach(el=>el.addEventListener('input', compute));
    $('#swapBtn').addEventListener('click',()=>{ const c=ratioChem.value; ratioChem.value=ratioWater.value; ratioWater.value=c; updateFromRatio(); compute(); });
    $('#resetBtn').addEventListener('click',()=>{ ratioChem.value=1; ratioWater.value=10; water.value=1; waterUnit.value='L'; total.value=1; totalUnit.value='L'; percent.value=9.1; mode='water'; tabs.forEach(x=>x.classList.toggle('active',x.dataset.mode==='water')); waterWrap.style.display='block'; totalWrap.style.display='none'; percentWrap.style.display='none'; updateFromRatio(); compute(); });

    function compute(){ let c=clampPos(ratioChem.value); let w=clampPos(ratioWater.value); if(mode==='percent'){ applyPercentToRatio(); c=clampPos(ratioChem.value); w=clampPos(ratioWater.value);} const fracC=c/(c+w), fracW=w/(c+w);
      if(!isFinite(fracC)|| (c===0&&w===0)){ chemMain.textContent='—'; waterMain.textContent='—'; chemAlt.textContent=''; waterAlt.textContent=''; return; }
      let chemML=0, waterML=0; if(mode==='water'){ const waterAmountML=Unit.toML(Number(water.value||0),waterUnit.value); chemML=(c/w)*waterAmountML; waterML=waterAmountML; }
      else { const totalAmountML=Unit.toML(Number(total.value||0),totalUnit.value); chemML=totalAmountML*fracC; waterML=totalAmountML*fracW; }
      const baseUnit=(mode==='water')?waterUnit.value:totalUnit.value; const altUnit= baseUnit==='L'?'mL': baseUnit==='mL'?'L': baseUnit==='oz'?'mL':'oz';
      chemMain.textContent=`${Unit.fmt(Unit.fromML(chemML,baseUnit))} ${baseUnit}`; waterMain.textContent=`${Unit.fmt(Unit.fromML(waterML,baseUnit))} ${baseUnit}`;
      chemAlt.textContent=`${Unit.fmt(Unit.fromML(chemML,altUnit))} ${altUnit}`; waterAlt.textContent=`${Unit.fmt(Unit.fromML(waterML,altUnit))} ${altUnit}`;
    }

    function applyHash(){ if(!location.hash) return; const q=new URLSearchParams(location.hash.slice(1)); if(q.get('c')) ratioChem.value=+q.get('c'); if(q.get('w')) ratioWater.value=+q.get('w'); const m=q.get('mode'); if(['water','total','percent'].includes(m)){ mode=m; tabs.forEach(x=>x.classList.toggle('active',x.dataset.mode===m)); waterWrap.style.display=m==='water'?'block':'none'; totalWrap.style.display=m==='total'?'block':'none'; percentWrap.style.display=m==='percent'?'block':'none'; } if(q.get('amt')){ (mode==='water'?water:total).value=+q.get('amt'); } if(q.get('u')){ (mode==='water'?waterUnit:totalUnit).value=q.get('u'); } if(q.get('pct')){ percent.value=+q.get('pct'); } updateFromRatio(); compute(); }
    function updateHash(){ const p=new URLSearchParams(); p.set('c',ratioChem.value); p.set('w',ratioWater.value); p.set('mode',mode); p.set('amt',(mode==='water'?water.value:total.value)); p.set('u',(mode==='water'?waterUnit.value:totalUnit.value)); if(mode==='percent') p.set('pct',percent.value); history.replaceState(null,'','#'+p.toString()); }
    ['input','change'].forEach(evt=>{ document.addEventListener(evt,updateHash); });

    // -------- Bottle planning & adjustable water --------
    const bottle=document.querySelector('#bottle'); const bottleUnit=document.querySelector('#bottleUnit');
    const waterOverride=document.querySelector('#waterOverride'); const waterOverrideUnit=document.querySelector('#waterOverrideUnit');
    const bottleChem=document.querySelector('#bottleChem'); const bottleChemAlt=document.querySelector('#bottleChemAlt');
    const bottleWater=document.querySelector('#bottleWater'); const bottleWaterAlt=document.querySelector('#bottleWaterAlt');
    const bottleNote=document.querySelector('#bottleNote');
    function planBottle(){ const c=Math.max(0,+ratioChem.value||0), w=Math.max(0,+ratioWater.value||0); const fracC=c/(c+w), fracW=w/(c+w); const bUnit=bottleUnit.value; const bottleML=Unit.toML(+bottle.value||0,bUnit);
      if(!isFinite(fracC)||bottleML<=0){ bottleChem.textContent='—'; bottleWater.textContent='—'; bottleChemAlt.textContent=''; bottleWaterAlt.textContent=''; bottleNote.textContent=''; return; }
      const recChemML=bottleML*fracC, recWaterML=bottleML*fracW; let useWaterML=recWaterML;
      if(waterOverride && waterOverride.value){ const u= waterOverrideUnit.value==='same'?bUnit:waterOverrideUnit.value; useWaterML=Unit.toML(+waterOverride.value||0,u); }
      let useChemML=Math.max(0,bottleML-useWaterML);
      const altUnit=bUnit==='L'?'mL': bUnit==='mL'?'L': bUnit==='oz'?'mL':'oz';
      bottleChem.textContent=`${Unit.fmt(Unit.fromML(useChemML,bUnit))} ${bUnit}`; bottleWater.textContent=`${Unit.fmt(Unit.fromML(useWaterML,bUnit))} ${bUnit}`;
      bottleChemAlt.textContent=`${Unit.fmt(Unit.fromML(useChemML,altUnit))} ${altUnit}`; bottleWaterAlt.textContent=`${Unit.fmt(Unit.fromML(useWaterML,altUnit))} ${altUnit}`;
      const dev=recChemML>0? Math.abs(useChemML-recChemML)/recChemML*100:0; bottleNote.textContent= dev>1?`Note: This deviates from the exact ${c}:${w} ratio by ${dev.toFixed(1)}%.`:`Exact for ${c}:${w}.`; }
    document.querySelector('#planBottle').addEventListener('click', planBottle);
    [bottle,bottleUnit,waterOverride,waterOverrideUnit,ratioChem,ratioWater].forEach(el=>el&&el.addEventListener('input', planBottle));

    // -------- Chemical Library (inline JSON + import/export) --------
    let CHEM_DB=[
      { id:'kc-gs', brand:'Koch‑Chemie', name:'Green Star (GS)', uses:[
        {area:'Exterior APC', ratio:{c:1,w:5}, note:'Heavier cut'},
        {area:'Exterior APC', ratio:{c:1,w:30}, note:'Maintenance'},
        {area:'Interior APC', ratio:{c:1,w:10}},
        {area:'Interior APC', ratio:{c:1,w:20}},
        {area:'Floors / Industrial', ratio:{c:1,w:40}},
        {area:'Floors / Industrial', ratio:{c:1,w:120}},
        {area:'Minimum', ratio:{c:1,w:3}, note:'Do not go stronger than 1:3'}
      ]},
      { id:'bh-surfex', brand:'Bilt‑Hamber', name:'Surfex HD', uses:[
        {area:'Heavy degreasing', ratio:{c:1,w:5}},
        {area:'General exterior', ratio:{c:1,w:10}},
        {area:'Interior / light', ratio:{c:1,w:20}}
      ]},
      { id:'cp-multix', brand:'CarPro', name:'MultiX*', uses:[
        {area:'Heavy', ratio:{c:1,w:10}},
        {area:'General', ratio:{c:1,w:20}},
        {area:'Maintenance', ratio:{c:1,w:50}, note:'*Verify label for surface.'}
      ]},
      { id:'mg-d101', brand:"Meguiar's", name:'All Purpose Cleaner (D101)', uses:[
        {area:'Heavy', ratio:{c:1,w:4}},
        {area:'Medium', ratio:{c:1,w:10}},
        {area:'Light', ratio:{c:1,w:20}}
      ]},
      { id:'gyeon-apc', brand:'Gyeon', name:'APC*', uses:[
        {area:'Pre‑wash', ratio:{c:1,w:5}},
        {area:'General', ratio:{c:1,w:15}},
        {area:'Interior', ratio:{c:1,w:20}, note:'*Check surface compatibility.'}
      ]}
    ];

    const presetsEl=document.querySelector('#presets');
    const PRESETS=[
      {label:'APC interior 1:15', c:1, w:15}, {label:'APC exterior 1:10', c:1, w:10}, {label:'Degreaser 1:4', c:1, w:4},
      {label:'Wheel 1:15', c:1, w:15}, {label:'Pre‑wash foam 1:12', c:1, w:12}, {label:'Maintenance 1:20', c:1, w:20}, {label:'Strong 1:5', c:1, w:5}, {label:'Rinse‑free 1:256', c:1, w:256}
    ];
    PRESETS.forEach(p=>{ const b=document.createElement('button'); b.className='chip'; b.type='button'; b.textContent=p.label; b.addEventListener('click',()=>{ ratioChem.value=p.c; ratioWater.value=p.w; updateFromRatio(); compute(); window.scrollTo({top:0,behavior:'smooth'});}); presetsEl.appendChild(b); });

    function refreshBrandFilter(){ const brandSel=document.querySelector('#chemBrand'); const brands=Array.from(new Set(CHEM_DB.map(p=>p.brand))).sort(); brandSel.innerHTML='<option value="">All brands</option>'+brands.map(b=>`<option value="${b}">${b}</option>`).join(''); }
    function renderChemList(){ const q=(document.querySelector('#chemSearch').value||'').toLowerCase(); const brand=document.querySelector('#chemBrand').value; const list=document.querySelector('#chemList');
      const items=CHEM_DB.filter(p=>{ const hitBrand=!brand||p.brand===brand; const hitText=!q||(p.brand+" "+p.name).toLowerCase().includes(q); return hitBrand&&hitText; });
      if(items.length===0){ list.innerHTML='<p class="kicker">No products matched. Try different search terms.</p>'; return; }
      list.innerHTML=items.map(p=>{ const chips=p.uses.map(u=>{ const label=`${u.area}: ${u.ratio.c}:${u.ratio.w}`; const note=u.note?` — <span class="kicker">${u.note}</span>`:''; return `<button class="usechip" data-c="${u.ratio.c}" data-w="${u.ratio.w}" title="Apply ${label}">${label}</button>${note}`;}).join(' ');
        return `<div class="prod"><div class="brand">${p.brand}</div><h4 style="margin:.25rem 0">${p.name}</h4><div class="usechips">${chips}</div></div>`; }).join('');
      document.querySelectorAll('#chemList .usechip').forEach(btn=>btn.addEventListener('click',()=>{ ratioChem.value=+btn.dataset.c; ratioWater.value=+btn.dataset.w; updateFromRatio(); compute(); window.scrollTo({top:0,behavior:'smooth'});})); }

    document.querySelector('#exportDb').addEventListener('click',()=>{ const blob=new Blob([JSON.stringify(CHEM_DB,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='chemical_library.json'; document.body.appendChild(a); a.click(); a.remove(); });
    document.querySelector('#importDbInput').addEventListener('change', async e=>{ const file=e.target.files&&e.target.files[0]; if(!file)return; try{ const text=await file.text(); const data=JSON.parse(text); if(Array.isArray(data)){ CHEM_DB=data; refreshBrandFilter(); renderChemList(); } else { alert('Invalid JSON: expected an array'); } } catch(err){ alert('Failed to import JSON: '+err.message); } });
    ;['input','change'].forEach(ev=>{ document.querySelector('#chemSearch').addEventListener(ev,renderChemList); document.querySelector('#chemBrand').addEventListener(ev,renderChemList); });

    // -------- Init --------
    function init(){
      // Advanced defaults
      updateFromRatio(); compute(); applyHash();
      // Quick Mix first paint already done above
      // Chem library
      refreshBrandFilter(); renderChemList();
    }
    init();
  </script>
</body>
</html>
